The general idea is to take a list of taxa (e.g. the entire taxonomy.tsv file) and map them to wikidata Q_ids, e.g. for the open tree of life taxon OTT=770315, wikidata Qid=Q15978631

From the wikidata Qid, we can get the name of pages in various language wikipedias. This allows us to get the wikipedia page size (e.g. via 
enwiki-latest-page.sql.gz) and the number of recent visits (e.g. via wikidumps/pagecounts-*totals.bz2)

To map OTT taxa to Qids, we can use the source ids present in the taxonomy.tsv `sourceinfo` column (e.g. ncbi:9593), and map them to wikidata ids by looking through the wikidata dump for the data item that has that ncbi number (and similarly for worms, index fungorum, gbif numbers, etc.)

```
OT_VERSION=6
ServerScripts/TaxonMappingAndPopularity/CSV_base_table_creator.py ../static/FinalOutputs/Life_full_tree.phy data/OpenTree/ott/taxonomy.tsv data/EOL/identifiers.csv data/Wiki/wd_JSON/*.bz2 data/Wiki/wp_SQL/*.sql.gz data/Wiki/wp_pagecounts/*totals.bz2 --OpenTreeFile data/OpenTree/draftversion${OT_VERSION}.tre -o data/DBinputs/ordered -v --exclude Archosauria_ott335588 Dinosauria_ott90215 > data/DBinputs/ordered_output.log

```
## Popularity measures

1. `OTT2wikidata.py` which maps wikidata IDs onto taxa from the OpenTree [taxonomy.tsv](http://files.opentreeoflife.org/ott/) file using a [wikidata JSON dump](https://dumps.wikimedia.org/wikidatawiki/entities/). It also can produce an equivalent en.wikipedia title and Encyclopedia of Life ID for each taxon.
2. `EOLpage2imageIDs.py` which uses the [EoL API](http://eol.org/api/docs/pages) to find the best reusable images of OpenTree taxa, given their EoL IDs. Accessing the API can be a slow process, so this cannot easily be done for many hundreds of thousands of species.
3. `MatchPageSizeAndViews.py` which takes the wikipedia page titles associated with wikidata items then adds page sizes and [pageview statistics](http://dumps.wikimedia.org/other/pagecounts-ez/merged/) to each
4. `popularity_tree.py` which takes pageview and pagesize measures for nodes on the OpenTree, and generates measures of popularity (e.g. for particular leaf taxa)

Given that locating images is the time-consuming step, the most logical sequence to follow is 1) Create a mapping of `OTTid` -> `WikiDataID` -> `en.wikipedia_title` -> `eolID` for each taxon in the [OpenTree newick download](http://files.opentreeoflife.org/trees/) 2) Get page sizes and views for each en.wikipedia_title in the mapping 3) Calculate the (ancestor+descendant) popularity measures for each taxon in the mapping 4) Take the subset of these taxa which appear as _leaves_ on the crowdfunding tree, and use `EOLpage2imageIDs.py` to locate the best images for each leaf.

What then remains to be done is to work out the algorithm which populates the internal nodes of the crowdfunding tree with pictures, based on the quality of the picture, the popularity of the taxon, and the verifiability (trusted or unverified) of the image. I suggest that images with a rating of 2.5 or lower should be immediately disqualified from percolating up the tree. To rate and potentially crop a set of EoL data_object_IDs, you can try 

For sponsorship porposes, it may also be useful to calculate popularity measures for all potentially sponsorable leaves. This requires a fully populated crowdfunding tree file (fulltree.phy), which can be generated by creating fully comprehensive OpenTree files in `OpenTree_all`, then running `tree_and_meta_parser.pl` on the file at `user/fulltree.js` file. Popularity measures for all leaves in the fulltree.phy file can be calculated using 

```
OneZoomTouch/server_scripts/utilities/popularity_tree.py popularity.txt OpenTree/draftversion4.tre \
--exclude Dinosauria_ott90215 Archosauria_ott335588 --branch_length sum_ancestor_and_descendant_popularities \
--print_leaves_from_tree  OneZoomTouch/OZ_yan/fulltree.phy > popularity_list.txt
```

### collecting images and popularity measures

 To get popularity measures on en.wikipedia, we need to match OTT ids to en.wikipedia page titles.

These ID mappings can be done using the [Wikidata JSON dump](https://www.wikidata.org/wiki/Wikidata:Database_download). The script to create mappings is `OTT2wikidata.py`, which can produce a file such as `map_file.txt`. The script to add EoL image information (data_objID, URL, etc), possibly limiting it to a specific set of leaves, is at `EOLpage2imageIDs.py`, with an example output in `treetaxon_file_with_appended_imageIDs.txt`.

Popularity ratings can be calculated using `MatchPageSizeAndViews.py` (example output in `popularity.txt`). These can be integrated into a popularity measure for leaves using `popularity_tree.py`, which produces an output file such as `popularity_list.txt`.

The leaf popularity ratings in `popularity_list.txt` and EOL identifiers can be combined using some perl, e.g. for all leaves:

    perl -F'\t' -lane 'unless($popfile) {$pop{$F[0]}=$F[1]; $popfile=1 if eof} else {print join("\t",@F,$pop{$F[0]} || "")}' popularity_list.txt unique_map_file.txt > all_details.tsv

Which can then be sorted on popularity:

    sort -k 5,5nr -t$'\t' all_details.tsv > sorted_all_details.tsv

Or to combine it with image information (e.g. that in `treetaxon_file_with_appended_imageIDs.txt`):

    perl -F'\t' -lane 'unless($popfile) {$pop{$F[0]}=$F[1]; $popfile=1 if eof} else {print join("\t",@F,$pop{$F[0]} || "")}' ../poplist.txt treetaxon_file_with_appended_imageIDs.txt > leaf_details.tsv


The following tables of results have been obtained using [R](https://www.r-project.org)

```
> dat <- read.delim("/Users/yan/Documents/Research/OneZoom/OneZoomTouch/popularity.txt")
> viewcols <- grep('bz2',names(dat))
> daterange <- paste(sub(".*pagecounts([0-9\\.]+).*", "\\1", colnames(dat)[range(viewcols)]), collapse="to")
> newname <- paste('trTop2meanMonthlyPageviews', daterange, sep="")
> dat[newname] <- apply(dat[,viewcols],1,function(x) mean(sort(x, TRUE)[-1:-2])) #trim off the top 2 months, to kill spikes
> #write.table(dat[-viewcols], file="popularity2.tsv", sep = "\t", row.names = FALSE, quote=FALSE)
> dat[order(dat$trmeanMonthlyPageviews, decreasing=TRUE),][1:40,-viewcols]

         OTTid      enwiki_title page_size total_pageviews trmeanMonthlyPageviews
118243   563166               Cat    136870         4263370              196638.37
52159    247333               Dog    105845         3971710              182672.26
24721    117198            Quinoa     35368         4728103              176751.26
1249670 4888335       Ebola virus     47836              NA              170408.84
79663    378287   Galapagos shark     18281              NA              168041.58
127234   605194             Maize     84861              NA              162968.74
118237   563151              Lion    142246         3355049              153494.11
6796      31937             Wheat     74955              NA              152087.63
8944      42314             Tiger    124578         3171131              144625.89
8400      39541            Peanut     55262              NA              135086.16
143551   681762           Soybean    120489              NA              131485.95
138461   657948            Barley     54644              NA              131024.68
32935    156245            Lentil     12772              NA              128755.00
128761   612429          Chickpea     30749              NA              128328.74
166889   790381               Oat     30149              NA              123573.47
191018   904381         Buckwheat     39185              NA              119252.26
1249275 4811132               HIV     89794              NA              117464.68
19023     90215          Dinosaur    175706         2551958              117056.95
26184    124215      Killer whale    119224              NA              115397.63
145711   691846            Animal     51459         2506548              115370.32
116117   553001           Sorghum      9657              NA              115318.00
116122   553015               Rye     12714              NA              109029.37
75839    359905               Pea     30296              NA              107772.79
1248774 4807313             Virus    132497              NA              105591.74
52160    247341         Gray wolf    192309              NA              102666.79
184270   872573       Giant panda     88365         2211576              102035.84
178439   844192          Bacteria    131374              NA              101498.58
116431   554297 Great white shark     86916              NA               95822.05
96917    460509             Moose     82207              NA               95092.89
54201    257326           Bed bug     68891              NA               93076.79
47252    223669      Striped bass     20476              NA               90908.05
47767    226190        Blue whale     77075              NA               90415.21
17152     81461              Bird    165414              NA               88725.32
104017   494835            Potato     91252              NA               85089.79
8948      42322            Jaguar     77429              NA               84059.26
203124   962377          Platypus     63161              NA               83831.89
139901   664348     Tyrannosaurus    150184              NA               83499.79
158842   752759           Cheetah     72355              NA               83304.47
23360    111438        Tardigrade     37342              NA               81854.68
2249      10732        Polar bear    132308              NA               81227.79


> dat[order(dat$page_size, decreasing=TRUE),][1:40,-viewcols]

         OTTid              enwiki_title page_size total_pageviews trmeanMonthlyPageviews
124461   592259         Narcissus (plant)    241783              NA                    NaN
55503    263127              Golden eagle    204856              NA             25362.1053
107163   509853          Great horned owl    194213              NA             11176.8421
52160    247341                 Gray wolf    192309              NA            102666.7895
8105      38131                   Agrilus    178211            6628               305.8421
19023     90215                  Dinosaur    175706         2551958            117056.9474
17152     81461                      Bird    165414              NA             88725.3158
80196    380529                     Dingo    156346              NA             38126.6316
209190   991547                      Frog    155175              NA             57191.1053
139901   664348             Tyrannosaurus    150184              NA             83499.7895
74484    352914                    Fungus    145308              NA             76284.2632
118237   563151                      Lion    142246         3355049            153494.1053
125053   595171          Salvia divinorum    138988              NA             37397.3158
226069  1072344 North Pacific right whale    137213              NA              3749.6316
118243   563166                       Cat    136870         4263370            196638.3684
1248774 4807313                     Virus    132497              NA            105591.7368
2249      10732                Polar bear    132308              NA             81227.7895
169070   800317        Common minke whale    131682              NA              2046.3684
178439   844192                  Bacteria    131374              NA            101498.5789
193062   913935                   Primate    130572              NA             43947.3684
25808    122365            Myrmecia (ant)    129711              NA               323.6000
203941   965954               Lepidoptera    129710              NA             19112.5263
83704    397157             Spotted hyena    128030              NA             20423.2632
57807    273899               Spotted owl    127286              NA              2444.6316
123371   587300            Painted turtle    126446              NA             10011.6316
210157   996421                   Archaea    126376              NA             55077.4737
114341   544595                 Amphibian    126309              NA             45111.3158
221112  1048699                   Termite    124636              NA             33687.4737
8944      42314                     Tiger    124578         3171131            144625.8947
184268   872567                Brown bear    122023              NA             37524.1579
22342    106258            Woolly mammoth    120507              NA             33482.8947
143551   681762                   Soybean    120489              NA            131485.9474
45333    215086                       Ant    119229              NA             64425.4211
26184    124215              Killer whale    119224              NA            115397.6316
224018  1062253                    Insect    118666              NA             51784.5789
216312  1025545                  Bivalvia    118204              NA             15892.6842
200049   948469           Tasmanian devil    118011              NA             39806.3158
147163   698424                   Cetacea    117314              NA             18972.5789
58428    276851               Sperm whale    117103              NA             56009.8421
179860   851318              Beluga whale    116604              NA             24381.4211


> dat[order(dat$trmeanMonthlyPageviews*dat$page_size, decreasing=TRUE),][1:40,-viewcols]

         OTTid      enwiki_title page_size total_pageviews trmeanMonthlyPageviews
118243   563166               Cat    136870         4263370              196638.37
118237   563151              Lion    142246         3355049              153494.11
19023     90215          Dinosaur    175706         2551958              117056.95
52160    247341         Gray wolf    192309              NA              102666.79
52159    247333               Dog    105845         3971710              182672.26
8944      42314             Tiger    124578         3171131              144625.89
143551   681762           Soybean    120489              NA              131485.95
17152     81461              Bird    165414              NA               88725.32
1248774 4807313             Virus    132497              NA              105591.74
127234   605194             Maize     84861              NA              162968.74
26184    124215      Killer whale    119224              NA              115397.63
178439   844192          Bacteria    131374              NA              101498.58
139901   664348     Tyrannosaurus    150184              NA               83499.79
6796      31937             Wheat     74955              NA              152087.63
74484    352914            Fungus    145308              NA               76284.26
2249      10732        Polar bear    132308              NA               81227.79
1249275 4811132               HIV     89794              NA              117464.68
184270   872573       Giant panda     88365         2211576              102035.84
209190   991547              Frog    155175              NA               57191.11
116431   554297 Great white shark     86916              NA               95822.05
1249670 4888335       Ebola virus     47836              NA              170408.84
96917    460509             Moose     82207              NA               95092.89
104017   494835            Potato     91252              NA               85089.79
45333    215086               Ant    119229              NA               64425.42
39400    186816             Snake     97020              NA               78476.63
95993    455687              Dodo    109017              NA               69236.16
8400      39541            Peanut     55262              NA              135086.16
8942      42307            Cougar     93905              NA               77127.79
138461   657948            Barley     54644              NA              131024.68
47767    226190        Blue whale     77075              NA               90415.21
210157   996421           Archaea    126376              NA               55077.47
69129    327624             Koala     84157              NA               79593.11
58428    276851       Sperm whale    117103              NA               56009.84
120702   574724               Bat    107917              NA               60727.00
56899    269670          Mosquito     86758              NA               75364.00
52158    247331            Coyote     97667              NA               66755.74
8948      42322            Jaguar     77429              NA               84059.26
54201    257326           Bed bug     68891              NA               93076.79
24721    117198            Quinoa     35368         4728103              176751.26
224018  1062253            Insect    118666              NA               51784.58
```